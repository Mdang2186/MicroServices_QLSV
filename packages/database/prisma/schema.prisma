generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String    @id @default(uuid())
  username     String    @unique
  email        String    @unique
  passwordHash String
  role         String    @default("STUDENT")
  avatarUrl    String?
  isActive     Boolean   @default(true)
  lastLogin    DateTime?
  createdAt    DateTime  @default(now())
  lecturer     Lecturer?
  student      Student?
}

model Faculty {
  id        String     @id @default(uuid())
  code      String     @unique
  name      String
  deanName  String?
  lecturers Lecturer[]
  majors    Major[]
}

model Major {
  id           String       @id @default(uuid())
  facultyId    String
  code         String       @unique
  name         String
  adminClasses AdminClass[]
  faculty      Faculty      @relation(fields: [facultyId], references: [id], onUpdate: NoAction)
  students     Student[]
  subjects     Subject[]
}

model AdminClass {
  id        String    @id @default(uuid())
  majorId   String
  code      String    @unique
  name      String
  cohort    String?
  advisorId String?
  advisor   Lecturer? @relation(fields: [advisorId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  major     Major     @relation(fields: [majorId], references: [id], onUpdate: NoAction)
  students  Student[]
}

model Student {
  id            String       @id @default(uuid())
  userId        String       @unique
  adminClassId  String?
  majorId       String
  studentCode   String       @unique
  fullName      String
  dob           DateTime
  gender        String?
  phone         String?
  address       String?
  citizenId     String?
  emailPersonal String?
  gpa           Float        @default(0.0)
  totalCredits  Int          @default(0)
  status        String       @default("ACTIVE")
  enrollments   Enrollment[]
  grades        Grade[]
  adminClass    AdminClass?  @relation(fields: [adminClassId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  major         Major        @relation(fields: [majorId], references: [id], onUpdate: NoAction)
  user          User         @relation(fields: [userId], references: [id], onUpdate: NoAction)
  tuitionFees   TuitionFee[]
}

model Lecturer {
  id           String        @id @default(uuid())
  userId       String        @unique
  facultyId    String?
  lectureCode  String        @unique
  fullName     String
  degree       String?
  phone        String?
  adminClasses AdminClass[]
  classes      CourseClass[]
  faculty      Faculty?      @relation(fields: [facultyId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  user         User          @relation(fields: [userId], references: [id], onUpdate: NoAction)
}

model Semester {
  id            String        @id @default(uuid())
  code          String        @unique
  name          String
  startDate     DateTime
  endDate       DateTime
  isRegistering Boolean       @default(false)
  classes       CourseClass[]
  tuitionFees   TuitionFee[]
}

model Subject {
  id            String         @id @default(uuid())
  majorId       String
  code          String         @unique
  name          String
  credits       Int
  theoryHours   Int            @default(30)
  practiceHours Int            @default(15)
  description   String?
  classes       CourseClass[]
  grades        Grade[]
  requiredFor   Prerequisite[] @relation("PrerequisiteFor")
  prerequisites Prerequisite[] @relation("SubjectPrerequisites")
  major         Major          @relation(fields: [majorId], references: [id], onUpdate: NoAction)
}

model Prerequisite {
  id             String  @id @default(uuid())
  subjectId      String
  prerequisiteId String
  type           String
  prerequisite   Subject @relation("PrerequisiteFor", fields: [prerequisiteId], references: [id], onUpdate: NoAction)
  subject        Subject @relation("SubjectPrerequisites", fields: [subjectId], references: [id], onUpdate: NoAction)

  @@unique([subjectId, prerequisiteId])
}

model CourseClass {
  id           String          @id @default(uuid())
  subjectId    String
  semesterId   String
  lecturerId   String?
  code         String          @unique
  name         String
  maxSlots     Int             @default(60)
  currentSlots Int             @default(0)
  status       String          @default("OPEN")
  schedules    ClassSchedule[]
  lecturer     Lecturer?       @relation(fields: [lecturerId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  semester     Semester        @relation(fields: [semesterId], references: [id], onUpdate: NoAction)
  subject      Subject         @relation(fields: [subjectId], references: [id], onUpdate: NoAction)
  enrollments  Enrollment[]
  grades       Grade[]
}

model ClassSchedule {
  id            String      @id @default(uuid())
  courseClassId String
  dayOfWeek     Int
  startShift    Int
  endShift      Int
  room          String
  type          String
  courseClass   CourseClass @relation(fields: [courseClassId], references: [id], onDelete: Cascade)
}

model Enrollment {
  id            String      @id @default(uuid())
  studentId     String
  courseClassId String
  status        String      @default("PENDING")
  registeredAt  DateTime    @default(now())
  tuitionFee    Decimal
  courseClass   CourseClass @relation(fields: [courseClassId], references: [id], onUpdate: NoAction)
  student       Student     @relation(fields: [studentId], references: [id], onUpdate: NoAction)

  @@unique([studentId, courseClassId])
}

model Grade {
  id              String      @id @default(uuid())
  studentId       String
  courseClassId   String
  subjectId       String
  attendanceScore Float?
  midtermScore    Float?
  finalScore      Float?
  totalScore10    Float?
  totalScore4     Float?
  letterGrade     String?
  isPassed        Boolean     @default(false)
  courseClass     CourseClass @relation(fields: [courseClassId], references: [id], onUpdate: NoAction)
  student         Student     @relation(fields: [studentId], references: [id], onUpdate: NoAction)
  subject         Subject     @relation(fields: [subjectId], references: [id], onUpdate: NoAction)

  @@unique([studentId, subjectId, courseClassId])
}

model TuitionFee {
  id           String               @id @default(uuid())
  studentId    String
  semesterId   String
  totalAmount  Decimal
  paidAmount   Decimal              @default(0)
  isCompleted  Boolean              @default(false)
  deadline     DateTime?
  semester     Semester             @relation(fields: [semesterId], references: [id], onUpdate: NoAction)
  student      Student              @relation(fields: [studentId], references: [id], onUpdate: NoAction)
  transactions TuitionTransaction[]
}

model TuitionTransaction {
  id              String     @id @default(uuid())
  tuitionFeeId    String
  amount          Decimal
  paymentMethod   String
  transactionDate DateTime   @default(now())
  transactionCode String?
  tuitionFee      TuitionFee @relation(fields: [tuitionFeeId], references: [id], onUpdate: NoAction)
}